# Сервис оповещения о результатах игр WOG Arma 3

![Discord Notification Example](https://github.com/GGoyathlay/WRTD-ETL/blob/main/message.jpg)

## Описание проекта

Сервис для оповещения о результатах игр на проекте **WOG Arma 3**. Включает интеграцию с ботом для **Discord**, который отправляет информацию пользователям. Используется бот из другого моего проекта, поэтому в нем оставлены уже имеющиеся функции: оповещение о начале трансляции указанного стримера и отправка сообщений о новых клипах на его канале. Проект создан в учебных целях (на практике освоить ETL-процесс), но вполне работоспособен и используется на моем Discord-сервере.

## Источник данных

Сайт реплеев и статистики WOG Arma 3 был создан одним из игроков проекта по имени **GonzoPunkass**. Информация о прошедших играх (в дальнейшем для простоты будем называть это "реплей") выгружается на сайт [WOG Arma 3 Stats](https://stats.wogames.info/projects/wog-a3/games/). Данные представлены в двух видах: основная статистика об игре и запись игровых действий (доступна по кнопке "Реплей" внутри страницы конкретного отыгрыша миссии). 

Так как время появления конкретного реплея в общем доступе сложно угадать, интересующимся игрокам приходится регулярно проверять страницу, что не очень удобно. Для своевременного оповещения о новых реплеях и предоставлении краткой выжимки о результатах игры создан данный сервис.

## Применяемые технологии и инструменты

- **Python** - основной код проекта, операторы в DAG’ах
- **Docker** - контейнер для Airflow, контейнер для PostgreSQL
- **Apache Airflow** - оркестрация ETL-процесса
- **PostgreSQL** - основная БД для реплеев
- **SQLite** - вспомогательная БД для оповещений о стриме
- **SQL** - создание таблиц, выборки, запись в БД

## Схема работы

1. Загрузка данных с HTML-страницы реплея.
2. Загрузка JSON с записи игровых действий.
3. Парсинг этих данных.
4. Сохранение информации в БД PostgreSQL.
5. Выгрузка нужных данных из БД.
6. Отправка сообщения на Discord-сервер.

В Docker-контейнере развернута БД PostgreSQL, в которую с помощью DAG’ов Airflow сохраняются данные. Затем бот на основе полученных данных формирует сообщение и отправляет его в Discord. При этом запущенный бот отслеживает активность указанного стримера и отправляет оповещения о начале трансляции и новых клипах (функционал остался от прошлого проекта, не стал убирать).

## Структура БД

Классическая реляционная БД имеет следующий вид:
![DB_schema](https://github.com/GGoyathlay/WRTD-ETL/blob/main/DB_schema.jpg)
- `replay_main` - основная информация о реплеях
- `vehicles` - данные о технике на миссии
- `players` - данные об игроках на миссии
- `d_players` - словарь с данными об игроках
- `frags` - данные о фрагах
- `messages` - таблица с данными для отправки оповещений

## Установка и настройка

Следуйте инструкциям ниже для установки и настройки проекта:

1. Установите **Docker**, **Docker Compose**.
2. Установите **Python** и необходимые зависимости и библиотеки.
3. Измените личные данные (twitch-токен, логины и пароли), где это необходимо (в коде эти данные выделены скобками `<>`).
4. Запустите Dockerfile для БД PostgreSQL.
5. Создайте необходимые таблицы с помощью скрипта `create_tables.sql`.
6. Скопируйте папки `config`, `dags`, `logs`, `plugins` в целевую папку вместе с `docker-compose`.
7. Запустите `docker-compose` для Airflow.
8. Перейдите по адресу `<ваш_адрес:5433>`, выполните вход и укажите системные переменные в Airflow:
   - `current_replay = <номер реплея, с которого начинать отсчет>`
   - `db_conn_param = {параметры подключения к БД}`
9. Запустите `botrun.sh` (предварительно сделав файл исполняемым).
10. Добавьте запущенные контейнеры в одну сеть Docker.
11. Включите DAG’и в Airflow.

## Лицензия

Этот проект находится под лицензией MIT. Пожалуйста, ознакомьтесь с файлом LICENSE для получения подробной информации.

